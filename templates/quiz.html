{% extends "base.html" %}

{% block title %}Quiz - Dentistry Quiz{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
        <!-- Quiz Header -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-white">{{ quiz_data.topic }}</h2>
                    <p class="text-gray-400 text-sm mt-1">
                        Question <span id="currentQuestion">1</span> of {{ quiz_data.questions|length }}
                    </p>
                </div>
                <div class="text-right">
                    {% if quiz_data.time_limit %}
                    <p class="text-gray-400 text-sm">Time Remaining</p>
                    <p id="timer" class="text-2xl font-bold text-purple-400"></p>
                    {% else %}
                    <p class="text-gray-400 text-sm">Time Elapsed</p>
                    <p id="timer" class="text-2xl font-bold text-purple-400"></p>
                    {% endif %}
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="mt-4 bg-gray-700 rounded-full h-2">
                <div id="progressBar" class="bg-purple-600 h-2 rounded-full transition-all duration-300"
                    style="width: 0%"></div>
            </div>
        </div>

        <!-- Quiz Form -->
        <form id="quizForm" method="POST" action="{{ url_for('submit_quiz', quiz_id=quiz_id) }}">
            <div id="questionsContainer">
                {% for question in quiz_data.questions %}
                <div class="question-block bg-gray-800 rounded-lg shadow-xl p-6 mb-4 {% if not loop.first %}hidden{% endif %}"
                    data-question-index="{{ loop.index0 }}">
                    <!-- Question Text -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-white mb-2">
                            Question {{ loop.index }}
                        </h3>
                        <p class="text-gray-300 text-lg">{{ question.question }}</p>
                    </div>

                    <!-- Question Image (if exists) -->
                    {% if question.image_url %}
                    <div class="mb-6">
                        <img src="{{ question.image_url }}" alt="Question image"
                            class="max-w-full h-auto rounded-lg border border-gray-600">
                    </div>
                    {% endif %}

                    <!-- Answer Options -->
                    <div class="space-y-3">
                        {% for option in question.options %}
                        <label
                            class="flex items-center p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition duration-300">
                            <input type="radio" name="question_{{ question.id }}" value="{{ option.id }}"
                                class="w-5 h-5 text-purple-600 focus:ring-purple-500 focus:ring-2">
                            <span class="ml-3 text-white">{{ option.option }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Navigation Buttons -->
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 flex justify-between">
                <button type="button" id="prevBtn" onclick="navigate(-1)"
                    class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                    ← Previous
                </button>

                <div class="flex gap-4">
                    <button type="button" id="nextBtn" onclick="navigate(1)"
                        class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-300">
                        Next →
                    </button>

                    <button type="button" id="submitBtn" onclick="confirmSubmit()"
                        class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-300">
                        Submit Quiz
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4">
        <h3 class="text-2xl font-bold text-white mb-4">Submit Quiz?</h3>
        <p class="text-gray-300 mb-6">
            Are you sure you want to submit your quiz? Make sure you've answered all questions.
        </p>
        <div id="unansweredWarning"
            class="hidden bg-yellow-900 border border-yellow-600 text-yellow-200 px-4 py-3 rounded mb-4">
            <p class="font-semibold">⚠️ Warning</p>
            <p class="text-sm">You have <span id="unansweredCount"></span> unanswered question(s).</p>
        </div>
        <div class="flex gap-4">
            <button onclick="closeModal()"
                class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                Go Back
            </button>
            <button onclick="submitQuiz()"
                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                Submit
            </button>
        </div>
    </div>
</div>

<script>
    let currentQuestionIndex = 0;
    const totalQuestions = {{ quiz_data.questions| length }};
    const timeLimit = {% if quiz_data.time_limit %}{ { quiz_data.time_limit } } {% else %} null{% endif %};
    // Use elapsed seconds from server to avoid timezone issues
    let elapsedSeconds = {{ elapsed_seconds }};
    const serverTime = new Date("{{ server_time }}").getTime();
    const clientTimeAtLoad = new Date().getTime();

    // Initialize
    updateQuestionDisplay();
    startTimer();

    function navigate(direction) {
        const questions = document.querySelectorAll('.question-block');
        questions[currentQuestionIndex].classList.add('hidden');

        currentQuestionIndex += direction;

        questions[currentQuestionIndex].classList.remove('hidden');
        updateQuestionDisplay();
    }

    function updateQuestionDisplay() {
        document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;

        const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
        document.getElementById('progressBar').style.width = progress + '%';

        // Update button states
        document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;

        if (currentQuestionIndex === totalQuestions - 1) {
            document.getElementById('nextBtn').classList.add('hidden');
            document.getElementById('submitBtn').classList.remove('hidden');
        } else {
            document.getElementById('nextBtn').classList.remove('hidden');
            document.getElementById('submitBtn').classList.add('hidden');
        }
    }

    function startTimer() {
        const timerInterval = setInterval(() => {
            // Calculate time difference since page load
            const now = new Date().getTime();
            const clientElapsed = Math.floor((now - clientTimeAtLoad) / 1000);
            // Add to the server's elapsed time for accurate timing
            const totalElapsed = elapsedSeconds + clientElapsed;

            if (timeLimit) {
                const remaining = (timeLimit * 60) - totalElapsed;

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    alert('Time is up! Your quiz will be auto-submitted.');
                    document.getElementById('quizForm').submit();
                    return;
                }

                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent =
                        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                    // Warning at 1 minute
                    if (remaining <= 60) {
                        timerElement.classList.add('text-red-500');
                        timerElement.classList.remove('text-purple-400');
                    }
                }
            } else {
                const minutes = Math.floor(totalElapsed / 60);
                const seconds = totalElapsed % 60;
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent =
                        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
            }
        }, 1000);
    }

    function confirmSubmit() {
        const unanswered = countUnanswered();

        if (unanswered > 0) {
            document.getElementById('unansweredWarning').classList.remove('hidden');
            document.getElementById('unansweredCount').textContent = unanswered;
        } else {
            document.getElementById('unansweredWarning').classList.add('hidden');
        }

        document.getElementById('confirmModal').classList.remove('hidden');
    }

    function countUnanswered() {
        let count = 0;
        {% for question in quiz_data.questions %}
        if (!document.querySelector('input[name="question_{{ question.id }}"]:checked')) {
            count++;
        }
        {% endfor %}
        return count;
    }

    function closeModal() {
        document.getElementById('confirmModal').classList.add('hidden');
    }

    function submitQuiz() {
        document.getElementById('quizForm').submit();
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' && currentQuestionIndex < totalQuestions - 1) {
            e.preventDefault();
            navigate(1);
        } else if (e.key === 'ArrowLeft' && currentQuestionIndex > 0) {
            e.preventDefault();
            navigate(-1);
        }
    });

    // Save answers to localStorage (in case of refresh)
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', () => {
            const formData = new FormData(document.getElementById('quizForm'));
            const answers = {};
            for (let [key, value] of formData.entries()) {
                answers[key] = value;
            }
            localStorage.setItem('quiz_{{ quiz_id }}_answers', JSON.stringify(answers));
        });
    });

    // Restore answers from localStorage
    window.addEventListener('load', () => {
        const savedAnswers = localStorage.getItem('quiz_{{ quiz_id }}_answers');
        if (savedAnswers) {
            const answers = JSON.parse(savedAnswers);
            for (let [key, value] of Object.entries(answers)) {
                const radio = document.querySelector(`input[name="${key}"][value="${value}"]`);
                if (radio) radio.checked = true;
            }
        }
    });

    // Clear localStorage on submit
    document.getElementById('quizForm').addEventListener('submit', () => {
        localStorage.removeItem('quiz_{{ quiz_id }}_answers');
    });
</script>
{% endblock %}