{% extends "base.html" %}

{% block title %}Logging in... - Dentistry Quiz{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gray-900 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8 text-center">
        <div>
            <h2 class="mt-6 text-3xl font-extrabold text-white">
                Completing secure login...
            </h2>
            <p id="status-text" class="mt-2 text-sm text-gray-400">
                Please wait while we verify your credentials.
            </p>
        </div>
        <div class="flex justify-center">
            <svg class="animate-spin h-10 w-10 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 014 4H12A8 8 0 014 12z">
                </path>
            </svg>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Check hash first (implicit flow / default)
        let hash = window.location.hash.substring(1);
        let params = new URLSearchParams(hash);
        let accessToken = params.get('access_token');
        let refreshToken = params.get('refresh_token');
        let error = params.get('error');
        let errorDescription = params.get('error_description');

        // Check query params if hash is empty (PKCE flow or errors)
        if (!accessToken && !error) {
            const searchParams = new URLSearchParams(window.location.search);
            error = searchParams.get('error');
            errorDescription = searchParams.get('error_description');
            // Note: If using PKCE, 'code' would be here, but we are assuming implicit flow 
            // or that Supabase client handles 'code' -> 'token' exchange via redirect
        }

        if (error) {
            // Decode error description if it exists
            const msg = errorDescription ? decodeURIComponent(errorDescription.replace(/\+/g, ' ')) : error;
            alert('Login failed: ' + msg);
            window.location.href = "{{ url_for('auth') }}";
            return;
        }

        if (!accessToken) {
            // Check for PKCE code in query params
            const searchParams = new URLSearchParams(window.location.search);
            if (searchParams.has('code')) {
                // If code is present but we are here, it means the server didn't handle it.
                // Reloading might trigger the server-side handler again.
                console.log("PKCE code found, reloading...");
                window.location.reload();
                return;
            }

            // If no token in hash and no code in search params
            console.log("No access token found in hash.");
            alert('Login failed: No access token found.');
            window.location.href = "{{ url_for('auth') }}";
            return;
        }

        fetch("{{ url_for('auth_callback_exchange') }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                access_token: accessToken,
                refresh_token: refreshToken
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = data.redirect;
                } else {
                    alert('Login failed: ' + data.error);
                    window.location.href = "{{ url_for('auth') }}";
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('An error occurred during login.');
                window.location.href = "{{ url_for('auth') }}";
            });
    });
</script>
{% endblock %}